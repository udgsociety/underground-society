<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NyxOS v3.3 - Dynamic Events</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&family=Roboto+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-primary: 'Roboto Mono', monospace;
            --font-display: 'Share Tech Mono', monospace;
            --font-glitch: 'VT323', monospace;

            --color-black: #010203;
            --color-deep-bg: #030609; 
            --color-dark-grey: #0A0F14;
            --color-medium-grey: #181C22;
            --color-light-grey: #2C313A;
            
            --color-green-bright: #00FF41;
            --color-green-medium: #00b32d;
            --color-green-dark: #007a1f;
            
            --color-cyan-bright: #0DFFFF;
            --color-cyan-medium: #0aa1a1;
            
            --color-purple-bright: #DA00FF;
            --color-red-error: #FF1A4D;
            --color-orange-warning: #FFA500; 


            --glow-primary: 0 0 4px var(--color-green-bright), 0 0 8px var(--color-green-medium), 0 0 12px var(--color-green-dark);
            --glow-secondary: 0 0 4px var(--color-cyan-bright), 0 0 8px var(--color-cyan-medium);
            --glow-error: 0 0 5px var(--color-red-error), 0 0 10px var(--color-red-error);
            --glow-warning: 0 0 5px var(--color-orange-warning), 0 0 10px var(--color-orange-warning);


            /* POGBA: BACKGROUND_IMAGE_URL */
            --desktop-background-image: url('https://placehold.co/1920x1080/010203/030609.png?text=NYX_DESKTOP_BACKGROUND');
        
            --color-green-medium-rgb-values: 0,179,45;
            --color-green-bright-rgb-values: 0,255,65;
            --color-light-grey-rgb-values: 44,49,58;
            --color-cyan-bright-rgb-values: 13,255,255;
            --color-black-rgb-values: 1,2,3;
            --color-green-dark-rgb-values: 0,122,31;
            --color-orange-warning-rgb-values: 255,165,0;
            --color-red-error-rgb-values: 255,26,77;
        }

        /* --- Animations Globales --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes subtleScanline { 0% { background-position-y: 0px; } 100% { background-position-y: 4px; } } 
        @keyframes textGlitchEffect {
          0%, 100% { text-shadow: var(--glow-primary); opacity: 1; transform: skewX(0deg); }
          50% { text-shadow: 0 0 5px var(--color-red-error), 0 0 10px var(--color-red-error); opacity: 0.8; transform: skewX(2deg) translateX(2px); }
        }
        @keyframes pulseGlowSoft {
            0%, 100% { box-shadow: 0 0 8px rgba(var(--color-green-bright-rgb), 0.2); } 
            50% { box-shadow: 0 0 16px rgba(var(--color-green-bright-rgb), 0.4); }
        }
        @keyframes new-message-pulse {
            0% { background-color: var(--color-purple-bright); box-shadow: 0 0 10px var(--color-purple-bright); }
            50% { background-color: rgba(var(--color-purple-bright), 0.7); box-shadow: 0 0 20px var(--color-purple-bright); }
            100% { background-color: var(--color-purple-bright); box-shadow: 0 0 10px var(--color-purple-bright); }
        }
        @keyframes loading-spinner {
            to {transform: rotate(360deg);}
        }
        .spinner {
            display: inline-block;
            width: 1em; height: 1em;
            border: 2px solid rgba(var(--color-cyan-bright-rgb), 0.3);
            border-radius: 50%;
            border-top-color: var(--color-cyan-bright);
            animation: loading-spinner 0.6s linear infinite;
            margin-right: 5px;
            vertical-align: middle;
        }
        @keyframes node-scan-pulse-anim { /* Renamed from node-scan-pulse */
            0% { filter: drop-shadow(0 0 3px var(--color-cyan-bright)); }
            50% { filter: drop-shadow(0 0 10px var(--color-cyan-bright)) brightness(1.5); }
            100% { filter: drop-shadow(0 0 3px var(--color-cyan-bright)); }
        }
        .node-scanning { 
            animation: node-scan-pulse-anim 0.8s infinite;
        }


        /* --- Initialisation et Fond --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; }

        body {
            font-family: var(--font-primary);
            background-color: var(--color-deep-bg);
            background-image: 
                linear-gradient(rgba(var(--color-green-dark), 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--color-green-dark), 0.03) 1px, transparent 1px),
                var(--desktop-background-image);
            background-size: 20px 20px, 20px 20px, cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--color-green-bright);
            animation: fadeIn 1.2s ease-out;
            position: relative;
        }

        #matrix-rain-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; opacity: 0.4; 
        }

        /* --- Structure du Bureau NyxOS --- */
        #nyx-desktop {
            position: relative; width: 100%; height: 100%;
            display: flex; 
            flex-direction: column;
            z-index: 2;
            box-shadow: inset 0 0 200px rgba(0,0,0,0.8);
        }
        
        #nyx-desktop::before { /* Scanlines */
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.1) 50%);
            background-size: 100% 3px; 
            animation: subtleScanline 0.15s linear infinite;
            pointer-events: none; z-index: 3; opacity: 0.15;
        }

        /* --- Header NyxOS --- */
        #nyx-header {
            background: linear-gradient(to bottom, rgba(var(--color-dark-grey), 0.9), rgba(var(--color-black), 0.8));
            border-bottom: 1px solid var(--color-green-medium);
            padding: 0 20px; height: 45px; 
            display: flex; align-items: center; justify-content: space-between;
            font-family: var(--font-display); z-index: 10; backdrop-filter: blur(8px);
            box-shadow: 0 2px 15px rgba(0,0,0,0.5);
        }
        #nyx-logo { font-size: 1.7em; text-shadow: var(--glow-primary); display: flex; align-items: center; cursor: default;}
        #nyx-clock { font-size: 1em; color: var(--color-cyan-bright); text-shadow: var(--glow-secondary); }

        /* --- Zone Principale des Applications --- */
        #main-app-area { 
            flex-grow: 1; 
            position: relative; overflow: hidden; padding: 20px; z-index: 5; 
        }

        /* --- Footer NyxOS --- */
        #nyx-footer {
            background: linear-gradient(to top, rgba(var(--color-dark-grey), 0.9), rgba(var(--color-black), 0.8));
            border-top: 1px solid var(--color-green-medium);
            padding: 0 20px; height: 30px; 
            display: flex; align-items: center; justify-content: space-between;
            font-size: 0.8em; z-index: 10; backdrop-filter: blur(8px);
            box-shadow: 0 -2px 15px rgba(0,0,0,0.5);
        }
        #user-status, #system-status { color: var(--color-cyan-bright); opacity: 0.7; }
        #nyx-comms-status-indicator {
            width: 10px; height: 10px; background-color: var(--color-light-grey);
            border-radius: 50%; margin-left: 10px; display: inline-block;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        #nyx-comms-status-indicator.new-message {
            animation: new-message-pulse 1.5s infinite;
        }


        /* --- Fenêtres des Applications --- */
        .app-window {
            position: absolute; 
            background-color: rgba(var(--color-medium-grey), 0.94);
            border: 1px solid var(--color-green-dark);
            border-radius: 3px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.7), inset 0 0 0 1px rgba(var(--color-green-bright-rgb),0.1); 
            display: flex; flex-direction: column;
            min-width: 350px; min-height: 250px;
            backdrop-filter: blur(12px) brightness(0.75);
            resize: both; overflow: hidden; 
            animation: fadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .app-window.active {
            border-color: var(--color-green-bright);
            box-shadow: 0 8px 35px rgba(var(--color-green-bright-rgb), 0.4), inset 0 0 0 1px var(--color-green-bright); 
        }
        .window-header {
            background: linear-gradient(to bottom, var(--color-green-dark), rgba(var(--color-green-dark), 0.7)); 
            padding: 8px 12px; cursor: move;
            border-bottom: 1px solid var(--color-green-medium);
            display: flex; justify-content: space-between; align-items: center;
            font-family: var(--font-display);
        }
        .window-title { color: var(--color-green-bright); text-shadow: var(--glow-primary); font-size: 1.05em; }
        .window-buttons span {
            display: inline-block; width: 10px; height: 10px;
            border-radius: 50%; 
            margin-left: 5px; cursor: pointer;
            background-color: var(--color-light-grey); opacity: 0.8;
            transition: all 0.2s;
        }
        .window-buttons span.close-btn { background-color: var(--color-red-error); }
        .window-buttons span:hover { opacity: 1; transform: scale(1.1); filter: brightness(1.2); }

        .window-content {
            flex-grow: 1; padding: 15px; overflow: auto; 
            background-image: linear-gradient(rgba(var(--color-green-bright-rgb),0.01) 1px, transparent 1px); 
            background-size: 100% 3px; 
        }
        .window-content::-webkit-scrollbar { width: 8px; }
        .window-content::-webkit-scrollbar-track { background: rgba(var(--color-black-rgb),0.5); }
        .window-content::-webkit-scrollbar-thumb { background-color: var(--color-green-dark); }
        .window-content::-webkit-scrollbar-thumb:hover { background-color: var(--color-green-medium); }

        /* --- Terminal Spécifique --- */
        #terminal-output {
            white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;
            height: calc(100% - 32px); line-height: 1.6; font-size: 0.9em;
            text-shadow: 0 0 1px rgba(var(--color-green-bright-rgb), 0.3); 
        }
        .prompt-line { display: flex; margin-top: 6px; height: 26px; }
        .prompt { margin-right: 10px; font-family: var(--font-display); text-shadow: var(--glow-primary); font-size: 1.05em;}
        .terminal-input {
            background: transparent; border: none; color: var(--color-green-bright);
            flex-grow: 1; outline: none; font-family: inherit; font-size: 1.05em;
            caret-color: var(--color-purple-bright);
        }

        /* --- Echo Player (Lecteur Vidéo) --- */
        .echo-player-video { 
            width: 100%; height: auto; max-height: calc(100% - 60px); 
            background-color: #000;
            border: 1px solid var(--color-green-dark);
            margin-bottom: 10px;
        }
        .echo-player-controls { text-align: center; padding-top: 5px;}
        .echo-player-controls button {
            background-color: var(--color-green-dark); color: var(--color-green-bright);
            border: 1px solid var(--color-green-medium); padding: 6px 12px;
            font-family: var(--font-display); cursor: pointer; margin: 0 5px;
            border-radius: 2px; transition: background-color 0.2s;
        }
        .echo-player-controls button:hover { background-color: var(--color-green-medium); }

        /* --- Cognito Decryptor --- */
        .cognito-decryptor-input {
            width: 100%; padding: 10px; margin-bottom: 12px;
            background-color: rgba(var(--color-black-rgb), 0.6); 
            border: 1px solid var(--color-green-medium);
            color: var(--color-green-bright); font-family: var(--font-primary);
            border-radius: 2px; font-size: 1em;
        }
        .cognito-decryptor-button {
            background-color: var(--color-purple-bright); color: var(--color-black);
            border: none; padding: 10px 18px; font-family: var(--font-display);
            cursor: pointer; border-radius: 2px; transition: filter 0.2s; font-size: 1em;
        }
        .cognito-decryptor-button:hover { filter: brightness(1.2) saturate(1.2); }

        /* --- NyxComms (Messagerie) --- */
        .nyx-comms-container { display: flex; height: 100%; gap: 10px; }
        .message-list-panel { width: 35%; border-right: 1px solid var(--color-green-dark); overflow-y: auto; padding-right: 10px;}
        .message-view-panel { flex-grow: 1; overflow-y: auto; padding-left: 10px; }
        .message-item {
            padding: 8px 5px; border-bottom: 1px solid rgba(var(--color-green-dark-rgb), 0.5);
            cursor: pointer; transition: background-color 0.2s;
        }
        .message-item.unread { font-weight: bold; color: var(--color-green-bright); text-shadow: 0 0 2px var(--color-green-bright);}
        .message-item.read { font-weight: normal; color: var(--color-light-grey); opacity: 0.7;}
        .message-item:hover, .message-item.selected { background-color: rgba(var(--color-green-medium-rgb), 0.2); }
        .message-sender { font-weight: bold; color: var(--color-cyan-bright); font-size: 0.9em; }
        .message-subject { font-size: 0.85em; opacity: 0.9; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .message-timestamp { font-size: 0.7em; color: var(--color-light-grey); display: block; margin-top: 2px;}
        .message-body { white-space: pre-wrap; line-height: 1.5; font-size: 0.9em; }
        .message-body h4 { font-family: var(--font-display); color: var(--color-cyan-bright); margin-bottom: 8px; font-size: 1.1em; border-bottom: 1px dashed var(--color-cyan-medium); padding-bottom: 4px;}


        /* Classes de texte communes */
        .error { color: var(--color-red-error); animation: textGlitchEffect 0.3s; }
        .info { color: var(--color-cyan-bright); }
        .success { color: var(--color-green-bright); }
        .warning { color: var(--color-warning-color); }
        
        /* Boot Screen */
        #boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; color: var(--color-green-bright); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: var(--font-pixel); font-size: 1.5em; }
        #boot-text { margin-top: 20px; font-size: 0.8em; line-height: 1.4; }
        #boot-progress-bar-container { width: 70%; max-width: 500px; height: 22px; border: 1px solid var(--color-green-medium); margin-top: 15px; padding: 2px; background: rgba(var(--color-green-dark-rgb),0.3); }
        #boot-progress-bar { width: 0%; height: 100%; background: var(--color-green-bright); transition: width 0.15s linear; box-shadow: 0 0 8px var(--color-green-bright); }
        .nyx-logo-boot { font-family: var(--font-display); font-size: 3em; text-shadow: var(--glow-primary); margin-bottom: 10px; }

        /* --- Alerte Système --- */
        #system-alert-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 10002; 
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }
        .system-alert-window {
            background-color: var(--color-dark-grey);
            border: 2px solid var(--color-red-error);
            box-shadow: 0 0 30px var(--color-red-error), inset 0 0 10px rgba(var(--color-red-error-rgb), 0.3);
            padding: 25px;
            border-radius: 5px;
            text-align: center;
            max-width: 450px;
            animation: fadeIn 0.5s ease-out, alertPulse 1s infinite alternate;
        }
        .system-alert-window h3 {
            font-family: var(--font-display); color: var(--color-red-error);
            font-size: 1.8em; margin-bottom: 15px; text-shadow: var(--glow-error);
        }
        .system-alert-window p {
            font-size: 1em; margin-bottom: 20px; color: var(--color-light-grey);
        }
        .system-alert-window button {
            background-color: var(--color-red-error); color: var(--color-black);
            border: none; padding: 8px 20px; font-family: var(--font-display);
            cursor: pointer; border-radius: 3px; font-size: 1em;
            transition: background-color 0.2s, transform 0.2s;
        }
        .system-alert-window button:hover { background-color: #ff4d6a; transform: scale(1.05); }
        @keyframes alertPulse {
            0% { border-color: var(--color-red-error); box-shadow: 0 0 30px var(--color-red-error), inset 0 0 10px rgba(var(--color-red-error-rgb), 0.3); }
            100% { border-color: #ff4d6a; box-shadow: 0 0 40px #ff4d6a, inset 0 0 15px rgba(var(--color-red-error-rgb), 0.5); }
        }
        .system-alert-window.warning { 
            border-color: var(--color-orange-warning); 
            box-shadow: 0 0 30px var(--color-orange-warning), inset 0 0 10px rgba(var(--color-orange-warning-rgb), 0.3);
        }
        .system-alert-window.warning h3 { color: var(--color-orange-warning); text-shadow: 0 0 5px var(--color-orange-warning); }
        .system-alert-window.warning button { background-color: var(--color-orange-warning); }
        .system-alert-window.warning button:hover { background-color: #ffc300; }

    </style>
</head>
<body>
    <canvas id="matrix-rain-canvas"></canvas>
    <div id="system-alert-overlay">
        <div class="system-alert-window">
            <h3 id="system-alert-title">ALERTE SYSTÈME</h3>
            <p id="system-alert-message">Une activité suspecte a été détectée.</p>
            <button id="system-alert-close-btn">Compris</button>
        </div>
    </div>
    <div id="nyx-desktop" style="display:none;">
        <header id="nyx-header">
            <div id="nyx-logo">NyxOS</div>
            <div id="nyx-clock">--:--:--</div>
        </header>
        <main id="main-app-area">
            </main>
        <footer id="nyx-footer">
            <div id="user-status">USER: guest</div>
            <div id="system-status">SYSTEM: ONLINE <span id="nyx-comms-status-indicator"></span></div>
        </footer>
    </div>

    <div id="boot-screen">
        <div class="nyx-logo-boot">NYX OS</div>
        <pre id="boot-text-ascii" style="font-family: var(--font-pixel); font-size:0.6em; text-align:center; margin-bottom: 10px; color: var(--color-green-medium)">
        INITIALIZING CORE SYSTEMS...
        QUANTUM ENTANGLEMENT MATRIX... SYNCED
        NEURAL NETWORK INTERFACE... STANDBY
        ORACLE ECHO HANDLER... LOADING
        </pre>
        <div id="boot-text"></div>
        <div id="boot-progress-bar-container"><div id="boot-progress-bar"></div></div>
    </div>

    <script>
        // --- Configuration Globale ---
        /* POGBA: CUSTOM_MUSIC_URL */
        const customMusicUrl = ""; 

        window.onload = () => {
            // --- Script-scoped variables ---
            let terminalOutput, terminalInput, promptElement;
            let currentUser = 'guest';
            let currentDirectory = '/'; 
            let accessLevel = 0;
            const commandHistory = []; 
            let historyIndex = -1;   
            let currentEcho = null; 
            let failedLoginAttempts = 0;
            
            // --- Initialisation du Canvas Matrix Rain ---
            const canvas = document.getElementById('matrix-rain-canvas');
            const ctx = canvas.getContext('2d');
            let matrixInterval;

            function setupMatrix() { 
                if (!canvas || !ctx) return;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const alphabet = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッンABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 partícula';
                const fontSize = 12;
                const columns = Math.floor(canvas.width / fontSize);
                const rainDrops = Array(columns).fill(1).map(() => Math.random() * canvas.height); 

                function drawMatrix() {
                    if (!ctx) return; 
                    ctx.fillStyle = 'rgba(1, 2, 3, 0.03)'; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'rgba(0, 255, 65, 0.6)'; 
                    ctx.font = fontSize + 'px monospace';
                    rainDrops.forEach((y, ind) => {
                        const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                        const x = ind * fontSize;
                        ctx.fillText(text, x, y);
                        if (y > canvas.height && Math.random() > 0.99) { 
                            rainDrops[ind] = 0;
                        } else {
                            rainDrops[ind] = y + fontSize;
                        }
                    });
                }
                if (matrixInterval) clearInterval(matrixInterval);
                matrixInterval = setInterval(drawMatrix, 70); 
            }
            if (canvas) { setupMatrix(); window.addEventListener('resize', setupMatrix); }

            // --- Configuration Audio (Tone.js) ---
            let masterVolume = new Tone.Volume(-20).toDestination();
            const keyClickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, oscillator: { type: "square4" }, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.05 }, volume: -28 }).connect(masterVolume).triggerAttackRelease("C1", "64n");
            const errorSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.15, sustain: 0 }, volume: -15 }).connect(masterVolume).triggerAttackRelease("8n");
            const successSound = () => new Tone.PluckSynth({ attackNoise: 0.5, dampening: 6000, resonance: 0.8, volume: -15 }).connect(masterVolume).triggerAttackRelease("G4", "16n");
            const alertSound = () => new Tone.Synth({ oscillator: {type: 'triangle'}, envelope: {attack:0.05, decay:0.2, sustain:0.1, release:0.5}, volume: -10 }).connect(masterVolume).triggerAttackRelease('A3', '4n');

            let backgroundMusicPlayer;

            function startBackgroundMusic() {
                if (backgroundMusicPlayer && backgroundMusicPlayer.state === "started") return;
                if (!customMusicUrl) {
                    if(terminalOutput) appendToTerminal("Aucune URL de musique personnalisée définie.", "warning");
                    return;
                }
                backgroundMusicPlayer = new Tone.Player({ url: customMusicUrl, loop: true, autostart: false, volume: -18 }).toDestination(); 
                Tone.loaded().then(() => {
                    backgroundMusicPlayer.start();
                    if(terminalOutput) appendToTerminal("Musique personnalisée démarrée.", "success");
                }).catch(err => {
                    if(terminalOutput) appendToTerminal("Erreur chargement musique: " + err.message, "error");
                });
            }
            function stopBackgroundMusic() {
                if (backgroundMusicPlayer) {
                    backgroundMusicPlayer.stop().dispose();
                    backgroundMusicPlayer = null;
                    if(terminalOutput) appendToTerminal("Musique arrêtée.", "info");
                }
            }

            // --- DOM Elements ---
            const bootScreenEl = document.getElementById('boot-screen');
            const desktopEl = document.getElementById('nyx-desktop');
            const bootTextEl = document.getElementById('boot-text');
            const bootProgressBarEl = document.getElementById('boot-progress-bar');
            const nyxClockEl = document.getElementById('nyx-clock');
            const userStatusEl = document.getElementById('user-status');
            const systemStatusEl = document.getElementById('system-status');
            const commsIndicatorEl = document.getElementById('nyx-comms-status-indicator');
            const systemAlertOverlayEl = document.getElementById('system-alert-overlay');
            const systemAlertTitleEl = document.getElementById('system-alert-title');
            const systemAlertMessageEl = document.getElementById('system-alert-message');
            const systemAlertCloseBtnEl = document.getElementById('system-alert-close-btn');
            
            // --- Helper pour CSS Variables dans Canvas ---
            function getCssVariableValue(variableName) {
                return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
            }
            function getCssVariableRGBValues(variableName) { 
                return getCssVariableValue(variableName); 
            }

            // --- Système d'Alerte ---
            function triggerSystemAlert(message, type = 'warning', title = 'ALERTE SYSTÈME') {
                if (!systemAlertOverlayEl || !systemAlertTitleEl || !systemAlertMessageEl) return;
                systemAlertTitleEl.textContent = title;
                systemAlertMessageEl.textContent = message;
                systemAlertOverlayEl.style.display = 'flex';
                
                const alertWindow = systemAlertOverlayEl.querySelector('.system-alert-window');
                alertWindow.className = 'system-alert-window'; // Reset classes
                if (type === 'critical') {
                    alertWindow.classList.add('error'); 
                } else if (type === 'warning') {
                    alertWindow.classList.add('warning'); 
                } else {
                     alertWindow.style.borderColor = getCssVariableValue('--color-cyan-bright'); 
                     alertWindow.querySelector('h3').style.color = getCssVariableValue('--color-cyan-bright');
                     alertWindow.querySelector('button').style.backgroundColor = getCssVariableValue('--color-cyan-medium');
                }
                alertSound();
            }
            if(systemAlertCloseBtnEl) systemAlertCloseBtnEl.onclick = () => { if(systemAlertOverlayEl) systemAlertOverlayEl.style.display = 'none'; };


            // --- Window Manager ---
            class WindowManager {
                constructor(appAreaId) {
                    this.appArea = document.getElementById(appAreaId);
                    this.windows = []; this.zIndexCounter = 100; this.activeWindow = null;
                }
                createWindow(id, title, contentGenerator, options = {}) {
                    const win = document.createElement('div');
                    win.id = `window-${id}`; win.className = 'app-window';
                    win.style.width = options.width || '550px'; 
                    win.style.height = options.height || '400px';
                    const areaRect = this.appArea.getBoundingClientRect();
                    const defaultLeft = (areaRect.width - parseInt(win.style.width)) / 2;
                    const defaultTop = (areaRect.height - parseInt(win.style.height)) / 3;
                    win.style.left = options.left || `${defaultLeft + (Math.random()*50-25)}px`;
                    win.style.top = options.top || `${defaultTop + (Math.random()*50-25)}px`;
                    win.style.zIndex = this.zIndexCounter++;
                    const header = document.createElement('div'); header.className = 'window-header';
                    header.innerHTML = `<span class="window-title">${title}</span><div class="window-buttons"><span class="close-btn" title="Fermer"></span></div>`;
                    const content = document.createElement('div'); content.className = 'window-content';
                    if (typeof contentGenerator === 'string') content.innerHTML = contentGenerator;
                    else contentGenerator(content, win);
                    win.appendChild(header); win.appendChild(content);
                    this.appArea.appendChild(win); this.windows.push(win); this.setActive(win);
                    this.makeDraggable(win, header);
                    header.querySelector('.close-btn').addEventListener('click', (e) => { e.stopPropagation(); this.closeWindow(win.id); });
                    win.addEventListener('mousedown', () => this.setActive(win));
                    return win;
                }
                setActive(win) { this.windows.forEach(w => w.classList.remove('active')); win.classList.add('active'); win.style.zIndex = this.zIndexCounter++; this.activeWindow = win;}
                closeWindow(windowId) {
                    const win = document.getElementById(windowId);
                    if (win) {
                        win.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                        win.style.opacity = '0'; win.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            win.remove();
                            this.windows = this.windows.filter(w => w.id !== windowId);
                            if (this.activeWindow === win) this.activeWindow = null;
                        }, 200);
                    }
                }
                makeDraggable(element, handle) {
                     let offsetX, offsetY, isDragging = false;
                     const mainAppArea = this.appArea; 

                    handle.onmousedown = (e) => {
                        if (e.target.closest('.window-buttons')) return;
                        isDragging = true;
                        offsetX = e.clientX - element.offsetLeft;
                        offsetY = e.clientY - element.offsetTop;
                        this.setActive(element);
                        document.body.style.cursor = 'move';
                        e.preventDefault();
                    };
                    document.onmousemove = (e) => {
                        if (!isDragging) return;
                        let newX = e.clientX - offsetX;
                        let newY = e.clientY - offsetY;
                        
                        newX = Math.max(0, Math.min(newX, mainAppArea.offsetWidth - element.offsetWidth));
                        newY = Math.max(0, Math.min(newY, mainAppArea.offsetHeight - element.offsetHeight));

                        element.style.left = newX + 'px';
                        element.style.top = newY + 'px';
                    };
                    document.onmouseup = () => {
                        if (isDragging) { isDragging = false; document.body.style.cursor = 'default';}
                    };
                }
            }
            let windowManager = new WindowManager('main-app-area');

            // --- NyxMapper Logic ---
            const networkNodes = {
                'nyx_mainframe': { x: 150, y: 100, label: 'Nyx Mainframe', status: 'Online', connections: ['corp_firewall'], info: "Serveur central de NyxNet. Hautement sécurisé.", ip: "10.0.1.1", services: ["NSS (Port 2222)", "Echo Sync"], vulnerabilities: ["Aucune connue"], locked: false },
                'corp_firewall': { x: 350, y: 100, label: 'Corp Firewall XG-7', status: 'Active', connections: ['data_archive_alpha'], info: "Pare-feu de CorpX.", ip: "192.168.10.1", services: ["HTTP (Port 80)", "HTTPS (Port 443)", "HTTP-ALT (Port 8080)"], vulnerabilities: ["Port 8080 (HTTP Alt.) ouvert - Potentiel pour injection de commandes.", "Firmware v2.1.3 (Obsolète) - Vulnérabilité connue: CVE-2077-001"], locked: false },
                'data_archive_alpha': { x: 350, y: 250, label: 'Data Archive α', status: 'Verrouillé', connections: [], info: "Contient des données financières de CorpX. Chiffré AES-256.", ip: "10.10.5.12", services: ["Unknown"], vulnerabilities: ["Accès physique requis pour exploit direct", "Protocole d'authentification faible (default_password?)"], locked: true }, 
                'hidden_relay_zeta': { x: 150, y: 250, label: 'Relais Zeta', status: 'Offline', connections: [], info: "Ancien relais. Actuellement hors-service.", ip: "172.16.33.7", services: ["N/A"], vulnerabilities: ["Inconnues (Système hors-ligne)"], locked: true } 
            };
            let hoveredNodeKey = null;

            function drawNyxMapper(canvasElement) {
                if (!canvasElement) return;
                const mapCtx = canvasElement.getContext('2d');
                canvasElement.width = canvasElement.offsetWidth; 
                canvasElement.height = canvasElement.offsetHeight;

                mapCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                mapCtx.font = `10px ${getCssVariableValue('--font-display')}`;
                mapCtx.textAlign = 'center';

                mapCtx.strokeStyle = `rgba(${getCssVariableRGBValues('--color-green-medium-rgb-values')}, 0.3)`;
                mapCtx.lineWidth = 1; 
                Object.values(networkNodes).forEach(node => {
                    if (node.locked) return; 
                    node.connections.forEach(connId => {
                        if (networkNodes[connId] && !networkNodes[connId].locked) {
                            mapCtx.beginPath();
                            mapCtx.moveTo(node.x, node.y);
                            mapCtx.lineTo(networkNodes[connId].x, networkNodes[connId].y);
                            mapCtx.stroke();
                        }
                    });
                });

                Object.entries(networkNodes).forEach(([key, node]) => {
                    const isHovered = key === hoveredNodeKey;
                    mapCtx.beginPath();
                    mapCtx.arc(node.x, node.y, isHovered ? 22 : 20, 0, Math.PI * 2); 
                    
                    if (node.locked) {
                        mapCtx.fillStyle = `rgba(${getCssVariableRGBValues('--color-orange-warning-rgb-values')}, ${isHovered ? 0.8 : 0.6})`;
                        mapCtx.strokeStyle = getCssVariableValue('--color-orange-warning');
                    } else if (node.status && node.status.toLowerCase().includes("compromis")) { // Vérifier si le statut contient "compromis"
                         mapCtx.fillStyle = `rgba(${getCssVariableRGBValues('--color-red-error-rgb-values')}, ${isHovered ? 0.9 : 0.7})`;
                         mapCtx.strokeStyle = getCssVariableValue('--color-red-error');
                    }
                    else {
                        mapCtx.fillStyle = node.status === 'Online' || node.status === 'Active' ? 
                                         `rgba(${getCssVariableRGBValues('--color-green-bright-rgb-values')}, ${isHovered ? 0.95 : 0.75})` : 
                                         `rgba(${getCssVariableRGBValues('--color-light-grey-rgb-values')}, ${isHovered ? 0.75 : 0.55})`;
                        mapCtx.strokeStyle = node.status === 'Online' || node.status === 'Active' ? 
                                           getCssVariableValue('--color-green-bright') : 
                                           getCssVariableValue('--color-light-grey');
                    }
                    mapCtx.fill();
                    mapCtx.lineWidth = isHovered ? 2.5 : 1.5;
                    mapCtx.stroke();
                    
                    mapCtx.fillStyle = getCssVariableValue('--color-black'); 
                    mapCtx.fillText(node.locked ? "???" : node.label.substring(0,3).toUpperCase(), node.x, node.y + 3); 
                    
                    mapCtx.fillStyle = node.locked ? getCssVariableValue('--color-orange-warning') : (node.status && node.status.toLowerCase().includes("compromis") ? getCssVariableValue('--color-red-error') : getCssVariableValue('--color-cyan-bright')); 
                    mapCtx.fillText(node.locked ? "NŒUD VERROUILLÉ" : node.label, node.x, node.y + 35); 
                });
            }
            
            function getNyxMapperNodeAtPos(canvasElement, x, y) {
                if (!canvasElement) return null;
                const rect = canvasElement.getBoundingClientRect();
                const canvasX = x - rect.left;
                const canvasY = y - rect.top;
                for (const [key, node] of Object.entries(networkNodes)) {
                    const distance = Math.sqrt(Math.pow(canvasX - node.x, 2) + Math.pow(canvasY - node.y, 2));
                    if (distance < (hoveredNodeKey === key ? 28: 25) ) { 
                        return key;
                    }
                }
                return null;
            }


            // --- Système de Fichiers & Logique Terminal ---
            const fileSystem = {
                '/': { type: 'directory', children: ['readme.txt', 'login.sh', 'apps/', 'echo_fragments/', 'tools/'] },
                '/readme.txt': { type: 'file', content: ["NyxOS v3.0 'Oracle Echoes'", "Système de NyxNet pour l'analyse des Échos de l'Oracle.", "Utilisez './login.sh' pour vous connecter.", "Commandes: ls, cd, cat, help, apps, open <fichier.echo>"] },
                '/login.sh': { type: 'executable', action: (args) => attemptLogin(args) },
                '/apps/': {type: 'directory', children: ['NyxMapper.app', 'NyxComms.app', 'EchoPlayer.app', 'CognitoDecryptor.app']} ,
                '/apps/NyxMapper.app': {type: 'executable', action: () => {
                    windowManager.createWindow('nyx-mapper', 'NyxMapper v0.3', (contentDiv) => {
                        const canvasEl = document.createElement('canvas');
                        canvasEl.id = 'nyx-mapper-canvas';
                        contentDiv.appendChild(canvasEl);
                        
                        const observer = new ResizeObserver(() => {
                             if (canvasEl.offsetWidth > 0 && canvasEl.offsetHeight > 0) {
                                drawNyxMapper(canvasEl);
                                observer.unobserve(canvasEl); 
                             }
                        });
                        observer.observe(canvasEl);

                        canvasEl.addEventListener('mousemove', (e) => {
                            const key = getNyxMapperNodeAtPos(canvasEl, e.clientX, e.clientY);
                            if (key !== hoveredNodeKey) {
                                hoveredNodeKey = key;
                                drawNyxMapper(canvasEl); 
                                canvasEl.style.cursor = key ? 'pointer' : 'default';
                            }
                        });
                        canvasEl.addEventListener('click', (e) => {
                            const key = getNyxMapperNodeAtPos(canvasEl, e.clientX, e.clientY);
                            if (key) {
                                const node = networkNodes[key];
                                const tempInfoDiv = document.createElement('div'); 
                                tempInfoDiv.innerHTML = `<p class="info" style="text-align:center; padding: 20px;"><span class="spinner"></span> Sondage du nœud ${node.label}...</p>`;
                                const infoWindow = windowManager.createWindow(`node-info-temp-${key}`, `Sondage: ${node.label}`, 
                                    (contentDiv) => { contentDiv.appendChild(tempInfoDiv); }, 
                                    { width: '380px', height: '120px' }
                                );

                                setTimeout(() => {
                                    windowManager.closeWindow(infoWindow.id); 
                                    if (node.locked) {
                                        windowManager.createWindow(`node-info-${key}`, `Info: ${node.label}`, 
                                            `<div style="padding:15px; font-size:0.9em; text-align:center;">
                                                <p class="warning">ACCÈS VERROUILLÉ</p>
                                                <p style="margin-top:10px;">Des informations supplémentaires ou un outil spécifique sont requis.</p>
                                            </div>`, 
                                            { width: '350px', height: '150px' }
                                        );
                                        return;
                                    }
                                    let vulnerabilitiesHTML = node.vulnerabilities.map(v => `<li>${v}</li>`).join('');
                                    let servicesHTML = node.services.map(s => `<li>${s}</li>`).join('');

                                    windowManager.createWindow(`node-info-${key}`, `Info: ${node.label}`, 
                                        (contentDiv) => { 
                                            contentDiv.innerHTML = `<div style="padding:10px; font-size:0.85em; line-height:1.4;">
                                                <p><strong>Adresse IP:</strong> <span class="info">${node.ip || "N/A"}</span></p>
                                                <p><strong>Statut:</strong> <span class="${node.status === 'Online' || node.status === 'Active' ? 'text-green-bright' : (node.status.toLowerCase().includes('compromis') ? 'text-red-error' : 'text-orange-warning')}">${node.status}</span></p>
                                                <p><strong>Description:</strong> ${node.info || "Aucune information supplémentaire."}</p>
                                                <h4 style="margin-top:10px; color:var(--color-cyan-medium); border-bottom:1px dashed var(--color-cyan-medium); padding-bottom:3px;">Services Actifs:</h4>
                                                <ul style="list-style-type:square; margin-left:20px;">${servicesHTML || "<li>Aucun détecté</li>"}</ul>
                                                <h4 style="margin-top:10px; color:var(--color-orange-warning); border-bottom:1px dashed var(--color-orange-warning); padding-bottom:3px;">Vulnérabilités Connues:</h4>
                                                <ul style="list-style-type:square; margin-left:20px;">${vulnerabilitiesHTML || "<li>Aucune connue</li>"}</ul>
                                            </div>`;
                                        }, 
                                        { width: '400px', height: 'auto' } 
                                    );
                                }, 1000 + Math.random() * 500); 
                            }
                        });
                    }, {width: '650px', height:'450px'});
                }},
                '/apps/NyxComms.app': {type: 'executable', action: () => openNyxComms()},
                '/apps/EchoPlayer.app': {type: 'executable', action: (args) => openEchoPlayer(args && args[0] ? args[0] : null)},
                '/apps/CognitoDecryptor.app': {type: 'executable', action: () => openCognitoDecryptor()},
                '/echo_fragments/': {type: 'directory', children: ['fragment_alpha.echo', 'fragment_beta.echo', 'fragment_gamma.echo']}, 
                '/echo_fragments/fragment_alpha.echo': { 
                    type: 'echo_file', 
                    /* POGBA: VIDEO_URL_ECHO_ALPHA */
                    videoUrl: 'https://placehold.co/640x360/000000/00FF41.mp4?text=ECHO_ALPHA_VIDEO', 
                    enigma: "Quel est le mot de 4 lettres affiché en rouge à 0:03 dans la vidéo ?",
                    solution: "CODE",
                    unlocksNode: "data_archive_alpha", 
                    nextMessageId: "msg_alpha_solved"
                },
                '/echo_fragments/fragment_beta.echo': {
                    type: 'echo_file',
                    /* POGBA: VIDEO_URL_ECHO_BETA */
                    videoUrl: 'https://placehold.co/640x360/000000/0DFFFF.mp4?text=ECHO_BETA_VIDEO',
                    enigma: "Combien de cercles bleus apparaissent simultanément à la fin de la séquence ?",
                    solution: "3",
                    unlocksNode: "hidden_relay_zeta",
                    nextMessageId: "msg_beta_solved"
                },
                 '/echo_fragments/fragment_gamma.echo': { 
                    type: 'echo_file',
                    /* POGBA: VIDEO_URL_ECHO_GAMMA */
                    videoUrl: 'https://placehold.co/640x360/000000/DA00FF.mp4?text=ECHO_GAMMA_VIDEO',
                    enigma: "Quel est le symbole qui clignote rapidement après le logo CorpX ?",
                    solution: "OMEGA", 
                    unlocksNode: null, 
                    nextMessageId: "msg_gamma_solved"
                },
                '/tools/': {type: 'directory', children: ['PortProbe.tool', 'BasicExploit.sh', 'DataLeech.payload'], owner: 'nyx_user', permissions: 'rwxr-x---', protected: 1}, 
                '/tools/PortProbe.tool': {
                    type: 'executable',
                    action: (args) => {
                        if (!args[0]) {
                            appendToTerminal("Usage: ./tools/PortProbe.tool <node_id>", "info");
                            return;
                        }
                        const targetNodeKey = args[0];
                        const node = networkNodes[targetNodeKey];
                        if (node) {
                            if (node.locked) {
                                appendToTerminal(`Sondage sur ${targetNodeKey}: ERREUR - Nœud verrouillé ou inaccessible.`, "error");
                                errorSound();
                                return;
                            }
                            appendToTerminal(`<span class="spinner"></span>Sondage des ports sur ${node.label} (${node.ip})...`, "info", true);
                            setTimeout(() => {
                                let foundVuln = false;
                                if (node.vulnerabilities && node.vulnerabilities.length > 0) {
                                    appendToTerminal(`[PortProbe] Rapport pour ${node.label}:`, "info");
                                    node.vulnerabilities.forEach(vuln => {
                                        if (vuln.toLowerCase().includes("port")) {
                                            appendToTerminal(`  <span class="warning">OUVERT:</span> ${vuln}`, "warning", true);
                                            foundVuln = true;
                                        }
                                    });
                                }
                                if (!foundVuln) {
                                    appendToTerminal(`[PortProbe] Aucun port vulnérable évident détecté sur ${node.label}.`, "success");
                                } else {
                                     addNewNyxMessage({
                                        id: `msg_portprobe_${targetNodeKey}_${Date.now()}`, sender: 'Nyx_IntelFeed', subject: `Rapport PortProbe: ${node.label}`, timestamp: new Date().toLocaleTimeString('fr-FR', {hour12:false}), 
                                        body: `Scan de ${node.label} (${node.ip}) terminé.\nDes ports ouverts ont été identifiés (voir terminal).\nUtilisez \`./tools/BasicExploit.sh ${targetNodeKey} <port_ou_mot_cle_vuln>\` pour tenter une intrusion.`, read: false
                                    });
                                }
                                successSound();
                            }, 2000 + Math.random() * 500);
                        } else {
                            appendToTerminal(`Erreur: Nœud cible '${targetNodeKey}' inconnu sur NyxMapper.`, "error");
                            errorSound();
                        }
                    },
                    description: "Sonde les ports d'un nœud réseau identifié."
                },
                '/tools/BasicExploit.sh': {
                    type: 'executable',
                    action: (args) => {
                        if (args.length < 2) {
                            appendToTerminal("Usage: ./tools/BasicExploit.sh <node_id> <port_ou_mot_cle_vuln>", "info");
                            return;
                        }
                        const targetNodeKey = args[0];
                        const exploitArg = args[1]; 
                        const node = networkNodes[targetNodeKey];

                        if (node) {
                            if (node.locked) {
                                appendToTerminal(`Exploit sur ${targetNodeKey}: ERREUR - Nœud verrouillé.`, "error"); errorSound(); return;
                            }
                            appendToTerminal(`<span class="spinner"></span>Tentative d'exploitation de ${node.label} avec '${exploitArg}'...`, "info", true);
                            setTimeout(() => {
                                let exploitSuccess = false;
                                if (targetNodeKey === 'corp_firewall' && (exploitArg === '8080' || exploitArg.toLowerCase().includes('http-alt') || exploitArg.toLowerCase().includes('cve-2077-001'))) {
                                    exploitSuccess = true;
                                    node.status = "Compromis (Port 8080)"; 
                                    appendToTerminal(`[BasicExploit] <span class="success">SUCCÈS!</span> Accès partiel obtenu sur ${node.label} via ${exploitArg}.`, "success", true);
                                    addNewNyxMessage({
                                        id: `msg_exploit_corp_${Date.now()}`, sender: 'Nyx_Infiltrator', subject: 'Brèche CorpX Firewall', timestamp: new Date().toLocaleTimeString('fr-FR', {hour12:false}), 
                                        body: `Exploit réussi sur Corp Firewall XG-7 (${exploitArg}).\nUn nouveau fragment d'Écho a été localisé : /echo_fragments/fragment_gamma.echo\nAnalysez-le immédiatement.`, read: false
                                    });
                                    if (fileSystem['/echo_fragments/'] && !fileSystem['/echo_fragments/'].children.includes('fragment_gamma.echo')) {
                                        fileSystem['/echo_fragments/'].children.push('fragment_gamma.echo');
                                    }
                                } else if (targetNodeKey === 'data_archive_alpha' && (exploitArg.toLowerCase().includes('default_password') || exploitArg.toLowerCase().includes('weak_auth'))) {
                                    exploitSuccess = true;
                                    node.status = "Compromis (Données Extraites)"; 
                                    appendToTerminal(`[BasicExploit] <span class="success">SUCCÈS!</span> Les identifiants par défaut ont fonctionné sur ${node.label}. Accès aux données obtenu.`, "success", true);
                                    if (!fileSystem['/tools/'].children.includes('DataLeech.payload')) {
                                        fileSystem['/tools/'].children.push('DataLeech.payload');
                                        appendToTerminal(`[NyxNet] Nouveau payload disponible : /tools/DataLeech.payload`, "success");
                                    }
                                    addNewNyxMessage({
                                        id: `msg_exploit_archive_${Date.now()}`, sender: 'Nyx_DataThief', subject: 'Archive CorpX compromise', timestamp: new Date().toLocaleTimeString('fr-FR', {hour12:false}), 
                                        body: `Accès obtenu à Data Archive α.\nLe payload /tools/DataLeech.payload est maintenant disponible pour extraire les données.`, read: false
                                    });
                                }
                                
                                if(exploitSuccess) {
                                    successSound();
                                    const mapperCanvas = document.getElementById('nyx-mapper-canvas');
                                    if(mapperCanvas) drawNyxMapper(mapperCanvas); 
                                } else {
                                    appendToTerminal(`[BasicExploit] <span class="error">ÉCHEC.</span> L'exploit sur ${node.label} avec '${exploitArg}' n'a pas fonctionné.`, "error", true);
                                    errorSound();
                                    triggerSystemAlert(`Tentative d'exploit échouée sur ${node.label}. Contre-mesures activées ?`, 'warning', 'ALERTE INTRUSION');
                                }
                            }, 2500 + Math.random() * 1500);
                        } else {
                            appendToTerminal(`Erreur: Nœud cible '${targetNodeKey}' inconnu.`, "error"); errorSound();
                        }
                    },
                    description: "Tente un exploit basique sur un service/port d'un nœud."
                },
                '/tools/DataLeech.payload': {
                    type: 'executable',
                    action: (args) => {
                        if (!args[0]) {
                            appendToTerminal("Usage: ./tools/DataLeech.payload <node_id_cible>", "info");
                            return;
                        }
                        const targetNodeKey = args[0];
                        const node = networkNodes[targetNodeKey];
                        if (node && node.status && node.status.toLowerCase().includes("compromis")) {
                            appendToTerminal(`<span class="spinner"></span>Extraction des données depuis ${node.label}...`, "info", true);
                            setTimeout(() => {
                                if (!fileSystem['/data/'].children.includes('oracle_core_schematics.dat')) {
                                    fileSystem['/data/'].children.push('oracle_core_schematics.dat');
                                    fileSystem['/data/oracle_core_schematics.dat'] = {type: 'file', content: ["SCHÉMAS NOYAU ORACLE - TOP SECRET", "-----------------------------------------", "Fragment 1: Algorithmes prédictifs.", "Fragment 2: Interface de contrôle neuronal.", "Fragment 3: Source d'énergie inconnue...", "AVERTISSEMENT: Données hautement volatiles."], owner: 'nyx_user', permissions: 'r--------', protected: 3};
                                    appendToTerminal(`[DataLeech] <span class="success">SUCCÈS!</span> Fichier /data/oracle_core_schematics.dat extrait.`, "success", true);
                                    addNewNyxMessage({
                                        id: `msg_dataleech_success_${Date.now()}`, sender: 'Nyx_OracleHunter', subject: 'SCHÉMAS DU NOYAU OBTENUS !', timestamp: new Date().toLocaleTimeString('fr-FR', {hour12:false}), 
                                        body: `Opérateur, vous avez réussi !\nLes schémas du noyau de l'Oracle sont entre nos mains (/data/oracle_core_schematics.dat).\nCeci est une avancée majeure. L'analyse de ces données est notre priorité absolue.\nLe Voile est plus fin que jamais...`, read: false
                                    });
                                    successSound();
                                } else {
                                    appendToTerminal(`[DataLeech] Les données ont déjà été extraites de ${node.label}.`, "info");
                                }
                            }, 3000 + Math.random()*1000);
                        } else {
                            appendToTerminal(`[DataLeech] Erreur: Impossible d'extraire les données. Le nœud ${targetNodeKey} n'est pas compromis ou n'existe pas.`, "error");
                            errorSound();
                        }
                    },
                    description: "Extrait des données d'un nœud préalablement compromis."
                }
            };
            function resolvePath(path, baseDir = currentDirectory) { /* ... (comme avant) ... */ return path; } 
            function getNode(path) { /* ... (comme avant) ... */ return fileSystem[path] || fileSystem[path+'/'] ; } 

            function updatePrompt() { if(promptElement) promptElement.innerHTML = `<span class="text-cyan-bright">${currentUser}@nyx-os</span>:<span class="text-purple-bright">${currentDirectory}</span>$&nbsp;`; }
            function appendToTerminal(text, type = '', html = false) { /* ... (comme avant) ... */ }
            function attemptLogin(args) { /* ... (comme avant) ... */ }
            
            // --- Logique des nouvelles applications ---
            function openEchoPlayer(filePath) { /* ... (comme avant) ... */ }
            function openCognitoDecryptor(echoData = null, echoName = "Inconnu") { /* ... (comme avant, avec la logique de déverrouillage de nœud et de message) ... */ }
            
            // --- NyxComms Logic ---
            const nyxMessages = [ /* ... (comme avant) ... */ ];
            let hasUnreadMessages = nyxMessages.some(msg => !msg.read);
            function updateCommsIndicator() { /* ... (comme avant) ... */ }
            function addNewNyxMessage(newMessage) { /* ... (comme avant) ... */ }
            function renderMessageListInComms(listPanel, viewPanel) { /* ... (comme avant) ... */ }
            function openNyxComms() { /* ... (comme avant) ... */ }


            async function handleCommand(cmd) { /* ... (comme avant, avec la logique de PortProbe et BasicExploit) ... */ }

            // --- Séquence de Boot ---
            const bootMessages = [ /* ... */ ];
            async function runBootSequence(messages) { /* ... (comme avant) ... */ }
            runBootSequence(bootMessages);

            // --- Horloge et Status ---
            function updateHeaderFooter() { /* ... (comme avant) ... */ }
            setInterval(updateHeaderFooter, 1000);
            updateHeaderFooter(); 
            
            document.body.addEventListener('click', async () => { if (Tone.context.state !== 'running') await Tone.start(); }, { once: true });
        };
    </script>
</body>
</html>
